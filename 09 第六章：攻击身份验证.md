# 09 第六章：攻击身份验证

表面上看，身份验证是网络应用程序中使用的所有安全机制中最简单的概念之一。在典型情况下，用户提供她的用户名和密码，应用程序必须验证这些项是否正确。如果是正确的，它就让用户进入。如果不是，它就不让用户进入。

身份验证也是应用程序保护免受恶意攻击的核心。它是抵御未经授权访问的第一道防线。如果攻击者能够击败这些防御措施，他通常可以获得对应用程序功能的完全控制，以及对其中存储的数据的无限制访问。如果没有可靠的身份验证，其他核心安全机制（如会话管理和访问控制）将无法有效。

事实上，尽管身份验证看起来很简单，但设计一个安全的身份验证功能是一件微妙的事情。在实际的网络应用程序中，身份验证通常是最薄弱的环节，这使得攻击者能够获得未经授权的访问。作者已经记不清由于身份验证逻辑中的各种缺陷，我们破坏了多少应用程序。

本章详细介绍了常见于网络应用程序的各种设计和实现缺陷。这些缺陷通常是由于应用程序设计人员和开发人员没有问一个简单的问题：如果攻击者针对我们的身份验证机制，他可以实现什么？在大多数情况下，一旦认真地对某个应用程序提出这个问题，就会出现一些潜在的漏洞，其中任何一个都可能足以破坏应用程序。

许多最常见身份验证漏洞都是显而易见的。任何人都可以在登录表单中输入字典单词，试图猜测有效的密码。在其他情况下，微妙的缺陷可能潜伏在应用程序的深层处理中，只有经过对复杂的多阶段登录机制的仔细分析才能发现和利用。我们将描述这些攻击的全部范围，包括成功破坏一些最安全关键和最强大防御的网络应用程序的身份验证的技术。

## 身份验证技术

在实现身份验证机制时，网络应用程序开发人员可以使用多种技术：

- 基于 HTML 表单的身份验证
- 多因子机制，例如结合密码和物理令牌的机制
- 客户端 SSL 证书和/或智能卡
- HTTP 基本和摘要身份验证
- 使用 NTLM 或 Kerberos 的 Windows 集成身份验证
- 身份验证服务

网络应用程序最常用的身份验证机制是使用 HTML 表单捕获用户名和密码，并将其提交给应用程序。这种机制占了您在互联网上可能遇到的应用程序的 90% 以上。

在安全性更高的互联网应用程序中，例如在线银行，这种基本机制通常扩展为多个阶段，要求用户提交额外的凭据，例如 PIN 码或从秘密单词中选择的字符。HTML 表单通常仍用于捕获相关数据。

在安全性最高的应用程序中，例如面向高价值个人的私人银行，通常会遇到使用物理令牌的多因子机制。这些令牌通常生成一系列一次性密码，或根据应用程序指定的输入执行挑战-响应功能。

随着这项技术的成本随着时间的推移而降低，越来越多的应用程序可能会采用这种机制。然而，这些解决方案中的许多实际上并没有解决它们为之设计的威胁——主要是网络钓鱼攻击和那些使用客户端特洛伊木马的攻击。

一些网络应用程序使用客户端 SSL 证书或在智能卡中实现的加密机制。由于管理和分发这些项目的开销，它们通常仅用于安全性关键的上下文，其中应用程序的用户群很小，例如用于远程办公室工作人员的基于 Web 的 VPN。

基于 HTTP 的身份验证机制（基本、摘要和 Windows 集成）很少用于互联网。它们在企业内部环境中更常见，在这些环境中，组织的内部用户通过提供其正常的网络或域凭据来访问公司应用程序。然后，应用程序使用这些技术之一处理这些凭据。

第三方身份验证服务，如 Microsoft Passport，偶尔会遇到，但在目前，它们还没有被大规模采用。

与身份验证相关的许多漏洞和攻击都可以应用于上述任何技术。由于基于 HTML 表单的身份验证的压倒性优势，我们将在此上下文中描述每个特定的漏洞和攻击。在相关的情况下，我们将指出与其他可用技术相关的任何特定差异和攻击方法。

## 身份验证机制中的设计缺陷

与网络应用程序中常用的任何其他安全机制相比，身份验证功能更容易受到设计缺陷的影响。即使在看似简单的标准模型中，应用程序基于用户的用户名和密码对用户进行身份验证，该模型的设计中的缺点也会使应用程序极易受到未经授权访问的影响。

### 弱密码

许多网络应用程序对用户密码的质量没有或只有最少的控制。常见的情况是，应用程序允许以下密码：

- 非常短或为空
- 常见的字典单词或名称
- 与用户名相同
- 仍设置为默认值

图 6-1 显示了弱密码质量规则的示例。最终用户通常对安全问题知之甚少。因此，一个不强制执行强密码标准的应用程序很可能包含大量设置了弱密码的用户帐户。攻击者可以轻松地猜测这些帐户的密码，从而未经授权地访问应用程序。

![](./img/101801.jpg)

图 6-1：一个强制执行弱密码质量规则的应用程序

#### 渗透步骤

尝试发现有关密码质量的任何规则：

1. 查看网站是否有任何关于规则的说明。
2. 如果可以进行自我注册，尝试注册多个帐户，使用不同类型的弱密码来发现有哪些规则。
3. 如果您控制单个帐户并且可以更改密码，请尝试将密码更改为各种弱值。

**注意** 如果密码质量规则仅通过客户端控制来强制执行，这本身不是安全问题，因为普通用户仍然受到保护。狡猾的攻击者可以给自己分配弱密码，这通常不会对应用程序的安全构成威胁。

### 暴力破解登录

登录功能向攻击者提供了一个公开邀请，尝试猜测用户名和密码，从而未经授权访问应用程序。

如果应用程序允许攻击者使用不同的密码进行重复的登录尝试，直到他猜对正确的密码，即使是业余攻击者手动将一些常见的用户名和密码输入到他的浏览器中，它也容易受到攻击。

最近对高知名度网站的破坏提供了访问数十万个真实世界的密码，这些密码以明文或使用暴力破解哈希存储。以下是最受欢迎的真实世界密码：

- password
- website name
- 12345678
- qwerty
- abc123
- 111111
- monkey
- 12345
- letmein

**注意** 管理员密码实际上可能比密码策略允许的更弱。它们可能是在策略生效之前设置的，或者可能是通过不同的应用程序或界面设置的。

在这种情况下，任何认真的攻击者都将使用自动化技术来尝试猜测密码，基于冗长的常见值列表。考虑到今天的带宽和处理能力，从标准 PC 和 DSL 连接可以每分钟尝试数千次登录。即使是最强大的密码最终也会在这种情况下被破解。

本章详细介绍了使用自动化进行这种方式的各种技术和工具。图 6-2 显示了使用 Burp Intruder 对单个帐户进行成功的密码猜测攻击。成功的登录尝试可以通过 HTTP 响应代码、响应长度和“登录不正确”消息的缺失来清楚地区分。

在某些应用程序中，客户端控件被用来尝试防止密码猜测攻击。例如，应用程序可以设置一个 cookie，例如 failedlogins=1，并在每次失败尝试后增加它。当达到某个阈值时，服务器在提交的 cookie 中检测到这一点，并拒绝处理登录尝试。这种客户端防御可以防止仅使用浏览器发起手动攻击，但它当然可以很容易地被绕过，如第 5 章所述。

![](./img/101802.jpg)

图 6-2：成功的密码猜测攻击

对前述漏洞的变体，当失败的登录计数器在当前会话中保留时，就会发生前述漏洞的变体。虽然客户端可能没有对此的任何指示，但攻击者需要做的只是获得一个新的会话（例如，通过保留他的会话 cookie），他就可以继续他的密码猜测攻击。

最后，在某些情况下，应用程序会在适当数量的失败登录后锁定目标帐户。但是，它对额外的登录尝试的响应是指示（或允许攻击者推断）所提供的密码是否正确。这意味着攻击者可以完成他的密码猜测攻击，即使目标帐户被锁定。

如果应用程序在一定延迟后自动解锁帐户，攻击者只需等待发生这种情况，然后像往常一样使用发现的密码登录。

**黑客步骤**

1. 手动提交您控制的帐户的多个错误登录尝试，监控您收到的错误消息。
2. 如果大约 10 次失败登录后，应用程序没有返回有关帐户锁定的消息，请尝试正确登录。如果成功，则可能没有帐户锁定策略。
3. 如果帐户被锁定，请尝试使用不同的帐户重复练习。这一次，如果应用程序发出任何 cookie，请每个 cookie 仅用于一次登录尝试，并为每次后续登录尝试获取一个新 cookie。
4. 此外，如果帐户被锁定，请查看提交有效密码是否会导致应用程序的行为与无效密码相比有任何差异。如果是这样，即使帐户被锁定，您也可以继续密码猜测攻击。
5. 如果您不控制任何帐户，请尝试枚举一个有效的用户名（请参阅下一节）并使用它进行多次错误登录。监控有关帐户锁定的任何错误消息。
6. 要安装暴力破解攻击，首先要识别应用程序在响应成功和失败登录时的行为差异。您可以使用此事实来区分自动化攻击过程中的成功和失败。
7. 获取枚举或常见的用户名列表和常见密码列表。使用有关密码质量规则的任何信息来调整密码列表，以避免多余的测试用例。
8. 使用合适的工具或自定义脚本快速生成使用所有这些用户名和密码的排列组合的登录请求。监控服务器的响应以识别成功的登录尝试。第 14 章详细描述了使用自动化执行自定义攻击的各种技术和工具。
9. 如果您同时针对多个用户名，通常最好以广度优先而不是深度优先的方式执行这种暴力破解攻击。这涉及迭代密码列表（从最常见的开始），并依次尝试每个密码。这种方法有两个好处。首先，您可以更快地发现具有常见密码的帐户。其次，您不太可能触发任何帐户锁定防御，因为在使用每个单独帐户的连续尝试之间存在时间延迟。

### 冗长的失败消息

典型的登录表单要求用户输入两条信息——用户名和密码。一些应用程序需要更多信息，例如出生日期、一个难忘的地方或 PIN 码。

当登录尝试失败时，您可以当然推断至少有一条信息是错误的。但是，如果应用程序告诉您哪条信息无效，您可以利用这种行为来大大降低登录机制的有效性。

在最简单的情况下，如果登录需要用户名和密码，应用程序可能会通过指示失败的原因是未识别的用户名还是错误的密码来响应失败的登录尝试，如图 6-3 所示。

![](./img/101803.jpg)

图 6-3：冗长的登录失败消息，指示何时猜测到有效的用户名

在这种情况下，您可以使用自动化攻击来迭代一个大的常见用户名列表，以枚举哪些是有效的。当然，用户名通常不被视为秘密（例如，它们在登录期间不会被屏蔽）。然而，为攻击者提供一种简单的方法来识别有效的用户名，增加了他在给定的时间、技能和努力下攻击应用程序的可能性。枚举的用户名列表可以用作各种后续攻击的基础，包括密码猜测、用户数据或会话攻击，或社会工程。

除了主登录功能之外，用户名枚举还可以出现在身份验证机制的其他组件中。原则上，任何提交实际或潜在用户名的功能都可以用于此目的。用户名枚举通常发现的一个位置是用户注册功能。如果应用程序允许新用户注册并指定自己的用户名，那么如果应用程序要防止注册重复的用户名，则几乎不可能阻止用户名枚举。有时可以在密码更改和忘记密码功能中找到用户名枚举的其他位置，如本章后面所述。

**注意** 许多身份验证机制或隐式或显式地披露用户名。在网络邮件帐户中，用户名通常是电子邮件地址，这是根据设计而公知的。许多其他站点在应用程序中公开用户名，而不考虑这给攻击者带来的优势，或以可预测的方式生成用户名（例如，user1842、user1843 等）。

在更复杂的登录机制中，当应用程序要求用户提交多条信息或经过多个阶段时，冗长的失败消息或其他区分符可以使攻击者依次针对登录过程的每个阶段，从而增加他获得未经授权访问的可能性。

**注意** 此漏洞可能以比此处所示更微妙的方式出现。即使响应有效和无效用户名返回的错误消息表面上相似，它们之间可能存在可以用来枚举有效用户名的细微差异。例如，如果应用程序中的多个代码路径返回“相同”的失败消息，则每个消息实例之间可能存在微小的排版差异。在某些情况下，应用程序的响应在屏幕上可能相同，但在 HTML 源代码中隐藏着细微的差异，例如注释或布局差异。如果没有明显的枚举用户名的方式，您应该对应用程序对有效和无效用户名的响应进行仔细比较。

您可以使用 Burp Suite 中的 Comparer 工具自动分析并突出显示两个应用程序响应之间的差异，如图 6-4 所示。这有助于您快速识别用户名的有效性是否导致应用程序响应的任何系统差异。

![](./img/101804.jpg)

图 6-4：使用 Burp Comparer 识别应用程序响应中的细微差异

**渗透步骤**

1. 如果您已经知道一个有效的用户名（例如，您控制的帐户），请使用此用户名和错误的密码提交一次登录，并使用随机用户名提交另一次登录。
2. 记录服务器对每次登录尝试的每个细节，包括状态代码、任何重定向、屏幕上显示的信息以及 HTML 页面源代码中隐藏的任何差异。使用您的拦截代理来维护到和从服务器的所有流量的完整历史记录。
3. 尝试发现服务器对两次登录尝试的任何明显或微妙的差异。
4. 如果失败，请在应用程序中可以提交用户名的任何位置重复练习（例如，自我注册、密码更改和忘记密码）。
5. 如果在服务器对有效和无效用户名的响应中检测到差异，请获取常见用户名的列表。使用自定义脚本或自动化工具快速提交每个用户名，并过滤表示用户名有效的响应（参见第 14 章）。
6. 在开始您的枚举练习之前，请验证应用程序是否在一定数量的失败登录尝试后执行任何帐户锁定（请参见前一节）。如果是这样，建议您在设计枚举攻击时考虑这一事实。例如，如果应用程序只允许您对任何给定帐户进行三次失败的登录尝试，您就有可能“浪费”其中一个，因为您通过自动枚举发现的每个用户名。因此，在执行枚举攻击时，不要在每次登录尝试中提交一个牵强的密码。相反，提交一个常见的密码，例如 password1 或用户名本身作为密码。如果密码质量规则较弱，则您作为枚举练习的一部分执行的一些尝试登录很可能会成功，并将在一次点击中披露用户名和密码。要将密码字段设置为与用户名相同，您可以在 Burp Intruder 中使用“撞锤”攻击模式，在登录请求中的多个位置插入相同的有效负载。

即使应用程序对包含有效和无效用户名的登录尝试的响应在每个内在方面都是相同的，仍然可能基于应用程序响应登录请求所需的时间来枚举用户名。应用程序通常对登录请求执行非常不同的后端处理，这取决于它是否包含有效的用户名。

例如，当提交有效的用户名时，应用程序可能会从后端数据库中检索用户详细信息，对这些详细信息执行各种处理（例如，检查帐户是否过期），然后在返回通用消息之前验证密码（这可能涉及资源密集的哈希算法）如果密码不正确。两个响应之间的时间差异可能太微妙，无法在仅使用浏览器时检测到，但自动化工具可能能够区分它们。

即使这种练习的结果包含大量的误报，仍然比拥有 10,000 个用户名列表好得多，其中大约 0.5% 是有效的。

请参阅第 15 章，详细了解如何检测和利用这种类型的时差从应用程序中提取信息。

**提示** 除了登录功能本身之外，还可能有其他信息来源，您可以从中获取有效的用户名。查看在应用程序映射（参见第 4 章）期间发现的所有源代码注释，以识别任何明显的用户名。组织内开发人员或其他人员的任何电子邮件地址都可能是有效的用户名，无论是全部还是仅用户特定的前缀。任何可访问的日志记录功能都可能会泄露用户名。

### **凭据的脆弱传输**

如果应用程序使用未加密的 HTTP 连接传输登录凭据，则网络上适当定位的窃听者当然可以拦截它们。根据用户的位置，潜在的窃听者可能居住在：

- 用户的本地网络上
- 用户的 IT 部门内
- 用户的 ISP 内
- 互联网主干上
- 托管应用程序的 ISP 内
- 管理应用程序的 IT 部门内

**注意** 这些位置中的任何一个都可能被授权人员占用，但也可能被通过其他方式破坏相关基础设施的外部攻击者占用。即使相信特定网络上的中间人是可以信任的，在通过它传递敏感数据时使用安全传输机制仍然更安全。

即使登录是通过 HTTPS 进行的，如果应用程序以不安全的方式处理凭据，凭据仍可能被未经授权的方披露：

- 如果凭据作为查询字符串参数传输，而不是在 POST 请求的主体中传输，这些凭据可能会在各种地方记录，例如在用户的浏览器历史记录中、在 Web 服务器日志中以及在托管基础设施中使用的任何反向代理的日志中。如果攻击者成功地破坏了这些资源中的任何一个，他可能会通过捕获存储在其中的用户凭据来升级权限。
- 虽然大多数网络应用程序确实使用 POST 请求的主体来提交 HTML 登录表单本身，但令人惊讶地常见的是看到登录请求通过重定向到具有相同凭据作为查询字符串参数的不同 URL 来处理。为什么应用程序开发人员认为有必要执行这些反弹尚不清楚，但是选择这样做后，将它们作为 302 重定向到 URL 比使用 JavaScript 提交的第二个 HTML 表单作为 POST 请求更容易实现。
- 网络应用程序有时将用户凭据存储在 cookie 中，通常用于实现设计不佳的登录、密码更改、“记住我”等机制。这些凭据容易受到攻击，这些攻击会破坏用户 cookie，并且在持久 cookie 的情况下，任何访问客户端本地文件系统的人都可以捕获这些凭据。即使凭据是加密的，攻击者仍然可以简单地重放 cookie，因此无需实际知道她的凭据即可作为用户登录。
- 第 12 章和第 13 章描述了攻击者可以用来攻击其他用户以捕获其 cookie 的各种方式。

许多应用程序对应用程序的未经身份验证的区域使用 HTTP，并在登录时切换到 HTTPS。如果是这种情况，则切换到 HTTPS 的正确位置是在浏览器中加载登录页面时，允许用户在输入凭据之前验证页面是否真实。但是，常见的是遇到使用 HTTP 加载登录页面本身，然后在提交凭据时切换到 HTTPS 的应用程序。这是不安全的，因为用户无法验证登录页面的真实性，因此没有保证凭据将被安全地提交。

适当定位的攻击者可以拦截和修改登录页面，将登录表单的目标 URL 更改为使用 HTTP。当精明的用户意识到凭据已使用 HTTP 提交时，它们将已被破坏。

#### 渗透步骤

1. 在监视客户端和服务器之间双向的所有流量的同时，执行成功的登录。
2. 识别在任何情况下凭据是否在任一方向传输。您可以在拦截代理中设置拦截规则，以标记包含特定字符串的消息（参见第 20 章）。
3. 如果发现任何实例，其中凭据以 URL 查询字符串或作为 cookie 提交，或从服务器传输到客户端，请了解正在发生什么，并尝试确定应用程序开发人员试图实现什么目的。尝试找到攻击者可能干扰应用程序的逻辑以破坏其他用户凭据的每种方式。
4. 如果任何敏感信息通过未加密的通道传输，这当然是容易被拦截的。
5. 如果没有识别到实际凭据被不安全地传输的任何情况，请密切关注任何似乎被编码或混淆的数据。如果这包括敏感数据，则可能可以对混淆算法进行逆向工程。
6. 如果使用 HTTPS 提交凭据，但登录表单是使用 HTTP 加载的，则应用程序容易受到中间人攻击，这可能用于捕获凭据。

翻译至p171